#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use Ivi\Core\Console\CommandRunner;

final class CliBootstrap
{
    private static function badge(string $label, string $color): string
    {
        $colors = [
            'red'    => "\033[1;31m",
            'green'  => "\033[1;32m",
            'yellow' => "\033[1;33m",
            'blue'   => "\033[1;34m",
            'cyan'   => "\033[1;36m",
            'gray'   => "\033[0;37m",
            'reset'  => "\033[0m",
        ];
        $start = $colors[$color] ?? $colors['reset'];
        $end   = $colors['reset'];
        return sprintf("[%s%s%s]", $start, strtoupper($label), $end);
    }

    public static function run(array $argv): void
    {
        $cmd = $argv[1] ?? null;

        // ---- Commande : ivi new <project> ----
        if ($cmd === 'new') {
            $projectName = $argv[2] ?? null;

            if (!$projectName) {
                echo self::badge('ERROR', 'red') . " Missing project name.\n";
                echo self::badge('INFO', 'yellow') . " Usage: ivi new <project-name>\n";
                exit(1);
            }

            echo self::badge('IVI', 'cyan') . " Creating new project: {$projectName}\n";

            $cmdLine = sprintf('composer create-project iviphp/ivi %s', escapeshellarg($projectName));
            passthru($cmdLine, $exitCode);

            if ($exitCode === 0) {
                echo self::badge('DONE', 'green') . " Project '{$projectName}' created successfully!\n";
                echo self::badge('TIP', 'yellow') . " Next steps:\n";
                echo "  cd {$projectName}\n";
                echo "  composer serve\n";
            } else {
                echo self::badge('ERROR', 'red') . " Project creation failed (code: {$exitCode})\n";
            }

            exit($exitCode);
        }

        // ---- Autres commandes CLI internes ----
        $runner = new CommandRunner();
        $runner->run($argv);
    }
}

// ---- Point d’entrée principal ----
CliBootstrap::run($argv);
